$(document).ready(function(){var e=140,t=[],n=window.localStorage;WB2.login(function(){$(".hidden").show(),WB2.anyWhere(function(e){e.parseCMD("/account/get_uid.json",function(t,n){if(n){var o=t.uid;e.parseCMD("/users/show.json",function(e){var t=e.screen_name;$(".username").show(),$("#username").text(t),$("#uid_text").val(t),"http://weibo.com/"+e.profile_url},{uid:o},{method:"get"})}},{},{method:"get"})})}),$("#username").click(function(){var e=require("nw.gui"),t=e.Window.get();return WB2.logout(function(){t.reload()}),!1}),$("#weibo_text").on("keyup change click",function(){var e=o($("#extra_content").val()+$(this).val());$("#info").text("已经输入"+e+"字")}),$("#extra_content").on("keyup change click",function(){var e=o($("#extra_content").val()+$("#weibo_text").val());$("#info").text("已经输入"+e+"字")});var o=function(t){for(var n=0,o=0;o<t.length&&2*e>=n;o++)n++;return n};$("#fans_list").on("click",".fans",function(){var e=$(this).data("value"),t=$("#weibo_text").val();t+="@"+e+" ",$("#weibo_text").val(t);var n=o($("#extra_content").val()+t);$("#info").text("已经输入"+n+"字")});var r=function(){$(".delete_box").fadeIn()},i=function(){$(".delete_box").fadeOut()};$("#send_to_btn").click(function(){var t=$("#weibo_id").val();if(""==t)return alert("微博ID为空"),!1;var n=$("#extra_content").val()+$("#weibo_text").val(),r=o(n);return r>e?($("#info").text("字数太长啦！"),!1):($("#info").text("发送中"),n=encodeURI(n),WB2.anyWhere(function(e){e.parseCMD("/statuses/repost.json",function(e,t){t?$("#info").text("发送成功"):$("#info").text("发送失败")},{id:t,status:n,is_comment:0},{method:"post"})}),!1)}),$("#comment_to_btn").click(function(){var t=$("#weibo_id").val();if(""==t)return alert("微博ID为空"),!1;var n=$("#extra_content").val()+$("#weibo_text").val(),r=o(n);return r>e?($("#info").text("字数太长啦！"),!1):($("#info").text("发送中"),n=encodeURI(n),WB2.anyWhere(function(e){e.parseCMD("/comments/create.json",function(e,t){t?$("#info").text("发送成功"):$("#info").text("发送失败")},{id:t,comment:n},{method:"post"})}),!1)});var a=function(e,o,r,i){if(0==o){$("#info").text("加载完成，粉丝数:"+r);var c=JSON.stringify(t);return n.fans=c,n.uid=e,void 0}WB2.anyWhere(function(n){n.parseCMD("/friendships/followers.json",function(n,o){if(o){for(var r=$('<div class="fans"></div>'),c=n.users.length,l=n.users,s=0;c>s;s++){var u=r.clone(),d=l[s].screen_name;u.text(d),t.push(d),u.data("value",d),u.appendTo(i)}a(e,n.next_cursor,n.total_number,i)}},{screen_name:e,count:200,cursor:o},{method:"get"})})},c=function(){for(var e=t.length,n=$("#fans_list").html(""),o=t,r=$('<div class="fans"></div>'),i=0;e>i;i++){var a=r.clone(),c=o[i];a.text(c),a.data("value",c),a.appendTo(n)}$(".send").removeAttr("disabled")};$("#get_fans_btn").click(function(){var e=$("#uid_text").val();if(""==e)return alert("UID为空"),!1;var n=function(){$("#info").text("获取中"),WB2.anyWhere(function(n){n.parseCMD("/friendships/followers.json",function(n,o){if(o){t=[];for(var r=$("#fans_list").html(""),i=$('<div class="fans"></div>'),c=n.users.length,l=n.users,s=0;c>s;s++){var u=i.clone(),d=l[s].screen_name;u.text(d),t.push(d),u.data("value",d),u.appendTo(r)}a(e,n.next_cursor,n.total_number,r)}},{screen_name:e,count:200},{method:"get"})})};return n(),!1});var l,s,u=60,d=0,f=0,v=function(){var t=$("#weibo_id").val();if(""==t)return alert("微博ID为空"),$("#stop_send_btn").click(),void 0;var n=$("#extra_content").val()+$("#weibo_text").val(),r=o(n);return r>e?($("#info").text("字数太长啦！"),$("#stop_send_btn").click(),void 0):($("#info").text("发送中"),n=encodeURI(n),WB2.anyWhere(function(e){e.parseCMD("/statuses/repost.json",function(e,t){t?$("#info").text("发送成功"):($("#info").text("发送失败"),$("#stop_send_btn").click())},{id:t,status:n,is_comment:0},{method:"post"})}),void 0)};$("#auto_send_btn").click(function(){return clearInterval(l),clearInterval(s),f=0,u=$("#time_interval").val(),u=parseInt(u),(30>u||0/0==u)&&(u=30),d=u,$(this).attr("disabled","disabled"),$("#stop_send_btn").removeAttr("disabled"),l=setInterval(function(){$("#weibo_text").val("");for(var e=$("#fans_list > .fans").length,t=0;5>t&&e>f;t++,f++)$("#fans_list > .fans").eq(f).click();f==e&&(clearInterval(l),clearInterval(s),f=0,l=void 0,s=void 0,$("#info").text("全部发送完成")),v(),d=u},1e3*u),s=setInterval(function(){$("#info").text("下一次发送时间大约还有："+d--+"秒。"),0>d&&(d=0)},1e3),!1});var p=function(e){var n=e.data("value");t=_.reject(t,function(e){return e==n}),e.remove()};$("#fans_list").sortable({start:r,stop:i}),$("#delete_box").droppable({accept:"div.fans",drop:function(e,t){p(t.draggable)}}),$("#stop_send_btn").click(function(){return clearInterval(l),clearInterval(s),f=0,l=void 0,s=void 0,$(this).attr("disabled","disabled"),$("#auto_send_btn").removeAttr("disabled"),$("#info").text("已停止发送"),!1}),$("#export_fans_btn").click(function(){var e=$('<input type="file" nwsaveas>'),n=require("fs-extra");return e.click(),e.on("change",function(e){var o=e.currentTarget.files[0].path,r=t.join("\r\n");n.outputFile(o,r,function(e){e?$("#info").text("导出失败："+e):$("#info").text("导出成功")})}),!1}),$("#import_fans_btn").click(function(){var e=$('<input type="file" >'),n=require("fs-extra");return e.click(),e.on("change",function(e){var o=e.currentTarget.files[0].path;n.readFile(o,"utf8",function(e,n){e?$("#info").text("导入错误"):(n=n.replace(/^\uFEFF/,""),t=n.split("\r\n"),c(),$("#info").text("导入成功"))})}),!1})});